cmake_minimum_required(VERSION 3.8)
project(kaair_driver)

# C++ í‘œì¤€ ëª…ì‹œ (í˜„ëŒ€ì  C++ ê¸°ëŠ¥ì„ ìœ„í•´ í•„ìˆ˜)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# -------------------------------------------------------------------
# 1. ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ë¡œë“œ
# -------------------------------------------------------------------
find_package(ament_cmake REQUIRED)
find_package(hardware_interface REQUIRED)
find_package(rclcpp REQUIRED)
find_package(rclcpp_lifecycle REQUIRED)
find_package(pluginlib REQUIRED)
find_package(realtime_tools REQUIRED)

find_package(dynamixel_sdk REQUIRED)
find_package(serial REQUIRED)

# -------------------------------------------------------------------
# 2. ê³µí†µ í•˜ë“œì›¨ì–´ ë¡œì§ ë¼ì´ë¸ŒëŸ¬ë¦¬ (í™•ì¥ì„±ì˜ í•µì‹¬)
# -------------------------------------------------------------------
# [ê¸°ì¡´] Head (ë‹¤ì´ë‚˜ë¯¹ì…€) ë¡œì§
add_library(dxl_hw_lib SHARED
  src/head/dxl_hw.cpp
)
target_include_directories(dxl_hw_lib PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>
)
ament_target_dependencies(dxl_hw_lib
  dynamixel_sdk
)

# ğŸŒŸ [ì¶”ê°€ëœ ë¶€ë¶„] Lift (MD400) ë¡œì§
add_library(md485_hw_lib SHARED
  src/lift/md485_hw.cpp
)
target_include_directories(md485_hw_lib PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>
)
ament_target_dependencies(md485_hw_lib
  serial
)

# -------------------------------------------------------------------
# 3. ROS 2 Control Hardware Interface í”ŒëŸ¬ê·¸ì¸
# -------------------------------------------------------------------
add_library(kaair_driver SHARED
  src/head/head_hw_interface.cpp
  src/lift/lift_hw_interface.cpp
)

target_include_directories(kaair_driver PRIVATE include)

# ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬(dxl_hw_lib)ë¥¼ ë§í¬í•©ë‹ˆë‹¤.
target_link_libraries(kaair_driver dxl_hw_lib md485_hw_lib)

ament_target_dependencies(kaair_driver
  hardware_interface
  pluginlib
  rclcpp
  rclcpp_lifecycle
)

# -------------------------------------------------------------------
# 4. í…ŒìŠ¤íŠ¸/ë””ë²„ê¹…ìš© ì‹¤í–‰ íŒŒì¼
# -------------------------------------------------------------------
# Head í…ŒìŠ¤íŠ¸ìš©
add_executable(dxl_test_node src/head/test_dxl.cpp)
target_include_directories(dxl_test_node PRIVATE include)
target_link_libraries(dxl_test_node dxl_hw_lib)
ament_target_dependencies(dxl_test_node)

# Lift í…ŒìŠ¤íŠ¸ìš© ì‹¤í–‰ íŒŒì¼ (lift_test_node)
add_executable(lift_test_node src/lift/test_lift.cpp)
target_include_directories(lift_test_node PRIVATE include)
target_link_libraries(lift_test_node md485_hw_lib)
ament_target_dependencies(lift_test_node)

# -------------------------------------------------------------------
# 5. í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ ë° ì„¤ì¹˜
# -------------------------------------------------------------------
pluginlib_export_plugin_description_file(
  hardware_interface 
  hw_plugins.xml
)

# ì‹¤í–‰ íŒŒì¼ê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ëª¨ë‘ ì„¤ì¹˜
install(TARGETS 
  dxl_hw_lib
  md485_hw_lib
  kaair_driver
  dxl_test_node
  lift_test_node
  DESTINATION lib/${PROJECT_NAME}
)

# í—¤ë” íŒŒì¼ ì„¤ì¹˜ (ë‹¤ë¥¸ íŒ¨í‚¤ì§€ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡)
install(DIRECTORY include/ 
  DESTINATION include
)

if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  set(ament_cmake_copyright_FOUND TRUE)
  set(ament_cmake_cpplint_FOUND TRUE)
  ament_lint_auto_find_test_dependencies()
endif()

ament_package()